name: Electron Build for PR

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - '.electron-builder.config.js'
      - '.github/workflows/electron-build-pr.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  build-electron:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            os_short: mac
          - os: windows-latest
            os_short: win

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Verify project setup
        shell: bash #ê¸°ë³¸ shell ì„¤ì •
        run: |
          echo "âœ… Dependencies installed successfully"
          echo "ğŸ“ Project structure:"
          ls -la
          echo "ğŸ“¦ Checking if renderer source exists:"
          if [ -d "src/renderer" ]; then
            echo "âœ… src/renderer directory found"
          else
            echo "âŒ src/renderer directory not found"
            exit 1
          fi

      - name: Package Electron App
        run: pnpm run build:${{ matrix.os_short }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: electron-${{ matrix.os }}-${{ github.event.number }}
          if-no-files-found: warn
          path: |
            # macOS ë¹Œë“œ ê²°ê³¼ë¬¼
            electron-dist/*.dmg
            electron-dist/*.zip
            electron-dist/*.blockmap
            electron-dist/mac/**
            electron-dist/mac-arm64/**
            # Windows ë¹Œë“œ ê²°ê³¼ë¬¼
            # NSIS ì„¤ì¹˜ í”„ë¡œê·¸ë¨ (artifactName: ê±°ë¶€ê¸°ë¦°.${ext})
            electron-dist/ê±°ë¶€ê¸°ë¦°.*
            # Portable ë¹Œë“œ ê²°ê³¼ë¬¼ (í´ë” í˜•íƒœ)
            electron-dist/win-ia32-unpacked/**
            electron-dist/win-unpacked/**

  comment:
    needs: build-electron
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            // í˜„ì¬ workflow runì˜ ëª¨ë“  job ê°€ì ¸ì˜¤ê¸°
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            // ë¹Œë“œ jobë“¤ ì°¾ê¸° (matrixë¡œ ìƒì„±ëœ jobë“¤)
            const buildJobs = jobs.data.jobs.filter(job => 
              job.name.startsWith('build-electron')
            );

            // ëŒ“ê¸€ ë³¸ë¬¸ ìƒì„±
            let body = `## ğŸ”§ Electron Build Results\n\n`;

            buildJobs.forEach(job => {
              const osName = job.name.includes('macos') ? 'macOS' : 
                           job.name.includes('windows') ? 'Windows' : 
                           job.name;
              const statusIcon = job.conclusion === 'success' ? 'âœ…' : 
                                job.conclusion === 'failure' ? 'âŒ' : 'âš ï¸';
              const statusText = job.conclusion === 'success' ? 'Success' :
                               job.conclusion === 'failure' ? 'Failed' : 
                               job.conclusion === 'cancelled' ? 'Cancelled' : 'In Progress';
              
              body += `### ${statusIcon} ${osName}\n`;
              body += `- **Status**: ${statusText}\n`;
              body += `- **Job**: [${job.name}](${job.html_url})\n\n`;
            });

            body += `---\n*This is an automated comment.*`;

            // ê¸°ì¡´ ëŒ“ê¸€ ì°¾ê¸°
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('## ğŸ”§ Electron Build Results')
            );

            if (existingComment) {
              // ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body
              });
            } else {
              // ìƒˆ ëŒ“ê¸€ ì‘ì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
